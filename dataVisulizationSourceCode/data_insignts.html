<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Scams data insights in Australia</title>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <style>
            .container {
                text-align: center;
                display: flex;
                flex-direction: column; 
                justify-content: center;
                align-items: flex-start;
            }

            .map-title {
                font-size: 20px;
                margin-top: 10px;
                text-align: center;
            }

            .map {
                height: 300px;
            }

            .map-container {
                width: 100%;
                margin-bottom: 10px;
            }

            .linechart-container {
                width: 100%; 
            }


            .tooltip {
                position: absolute;
                text-align: left;
                width: auto;
                height: auto;
                padding: 10px;
                font: 12px sans-serif;
                background: lightgrey;
                border: 1px solid black;
                border-radius: 5px;
                pointer-events: none;
            }

            .piechart-container {
                width: 100%;
                margin-top: 30px;
                text-align: center;
            }

            #scamTypeSelect {
                margin-bottom: 20px; 
            }

            #pieChart {
                margin: 0 auto;
                display: block;
            }
        </style>

    </head>

    <body>


    <div class="container">
        <div class="map-container">
            <div class="map-title">Scams in Australia</div>
            <svg id="map" class="map"></svg>
        </div>
        <div class="linechart-container">
            <svg id="lineChart" class="linechart"></svg>
        </div>
    </div>

    <div id="tooltip" class="tooltip" style="opacity: 0"></div>

    <div class="piechart-container">
        <select id="scamTypeSelect">
            <option value="Betting and sports investment scams">Betting and sports investment scams</option>
            <option value="False billing">False billing</option>
            <option value="Investment scams">Investment scams</option>
            <option value="Phishing">Phishing</option>
        </select>
        <svg id="pieChart" width="400" height="400"></svg>
    </div>


    <script>
        // Implementing map
            const mapWidth = 1000; 
            const mapHeight = 800;

            const svgMap = d3
            .select("#map")
            .append("svg")
            .attr("preserveAspectRatio", "xMidYMid meet")
            .attr("viewBox", "0 0 " + mapWidth + " " + mapHeight);

            const projection = d3
            .geoMercator()
            .scale(1200)
            .center([133.7751, -25.2744])
            .translate([mapWidth / 2, mapHeight / 2]);

            const path = d3.geoPath().projection(projection);
            const tooltip = d3.select("#tooltip");

            let selectedState = null; 

            // Prepare data
            Promise.all([
            d3.json("australian-states.json"), 
            d3.csv("aggregated_reports_by_year_month_state.csv"), 
            d3.csv("aggregated_reports_for_tooltip.csv") 
            ])
            
            .then(([geoData, reportData, tooltipData]) => {
                const reportsByState = d3.rollups(
                    reportData,
                    v => d3.sum(v, d => +d.ReportCount),
                    d => d.State
            ).reduce((acc, [state, count]) => {
            acc[state] = count;
            return acc;
        }, {});

        const scamReportsByState = d3.group(reportData, d => d.State, d => d.ScamType);

        const overallData = d3.rollups(
            reportData,
            v => d3.sum(v, d => +d.ReportCount),
            d => d.Year + "-" + d.Month
        ).map(([key, value]) => ({ date: d3.timeParse("%Y-%m")(key), ReportCount: value }));

        var colorScale = d3.scaleSequential(d3.interpolateBlues).domain([0, d3.max(Object.values(reportsByState))]);

 
        svgMap.append("g")
            .selectAll("path")
            .data(geoData.features)
            .enter().append("path")
            .attr("d", path)
            .attr("fill", d => {
                var value = reportsByState[d.properties.STATE_NAME];
                return value ? colorScale(value) : "#ccc"; 
            })
            .attr("stroke", "black")
            .attr("stroke-width", 0.5)
            .on("mouseover", function(event, d) {
            tooltip.style("opacity", 1);
        })


        .on("mousemove", function(event, d) {
            const stateName = d.properties.STATE_NAME;
            const stateData = tooltipData.find(td => td.State === stateName);

            let tooltipContent = `<strong>${stateName}</strong><br>`;
    

            if (stateData) {
                if (stateData['Number of'] !== undefined) {
                    tooltipContent += `Number of Reports: ${stateData['Number of']}<br>`;
                }
                Object.keys(stateData).forEach(column => {
                    if (column !== 'State' && column !== 'Number of') { 
                        tooltipContent += `${column}: ${stateData[column]}<br>`;
                    }
                });
            } else {
                tooltipContent += `No data found.`;
            }
            tooltip.html(tooltipContent)
                .style("left", (event.pageX + 16) + "px")
                .style("top", (event.pageY - 29) + "px");
            })
            .on("mouseout", function() {
                tooltip.style("opacity", 0);
            })
            
            .on("click", function(event, d) {
                if (selectedState === d.properties.STATE_NAME) {
                    selectedState = null;
                    resetMapColors(reportsByState);
                    updateLines(overallData, "Total number of reports for Australia");
                } else {
                    selectedState = d.properties.STATE_NAME;
                    updateMapColors(d.properties.STATE_NAME, reportsByState);
                    const stateData = reportData.filter(rd => rd.State === selectedState)
                    .map(rd => ({
                        date: d3.timeParse("%Y-%m")(rd.Year + "-" + rd.Month),
                        ReportCount: +rd.ReportCount
                    }));
                    updateLines(stateData, `${selectedState} Reports`);
                }
            });
            updateLines(overallData, "Total number of reports for Australia");
            function updateMapColors(selected, reportsByState) {
                svgMap.selectAll("path")
                .attr("fill", d => d.properties.STATE_NAME === selected ? colorScale(reportsByState[d.properties.STATE_NAME]) : "#ccc");
            }
            
            function resetMapColors(reportsByState) {
                svgMap.selectAll("path")
                .attr("fill", d => {
                    var value = reportsByState[d.properties.STATE_NAME];
                    return value ? colorScale(value) : "#ccc";
                });
            }
        })


        const margin = {top: 50, right: 50, bottom: 50, left: 50};
        const width = 850 - margin.left - margin.right;
        const height = 450 - margin.top - margin.bottom;

        const svgLineChart = d3.select("#lineChart")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const line = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.ReportCount));

        function updateLines(data, title) {
            x.domain(d3.extent(data, d => d.date));
            y.domain([0, d3.max(data, d => d.ReportCount)]);

            svgLineChart.selectAll(".line").remove();

            svgLineChart.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line)
            .attr("fill", "none")  
            .attr("stroke", "steelblue")  
            .attr("stroke-width", 2); 


            svgLineChart.selectAll(".x-axis").remove();
            svgLineChart.append("g")
            .attr("class", "x-axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%b %Y")))
            .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");


            svgLineChart.selectAll(".y-axis").remove();
            svgLineChart.append("g")
            .attr("class", "y-axis")
            .call(d3.axisLeft(y));


            svgLineChart.selectAll(".chart-title").remove();
            svgLineChart.append("text")
            .attr("class", "chart-title")
            .attr("x", width / 2)
            .attr("y", -margin.top / 2)
            .style("text-anchor", "middle")
            .style("font-size", "16px")
            .text(title);
        }


        d3.csv("scam_gender_data.csv").then(genderData => {
            const pieWidth = 400;
            const pieHeight = 400;
            const radius = Math.min(pieWidth, pieHeight) / 2;

            const svgPie = d3.select("#pieChart")
            .attr("width", pieWidth)
            .attr("height", pieHeight)
            .append("g")
            .attr("transform", `translate(${pieWidth / 2},${pieHeight / 2})`);

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const pie = d3.pie()
            .value(d => d.value);

            const arc = d3.arc()
            .innerRadius(0)
            .outerRadius(radius);

            function updatePieChart(scamType) {
                const normalizedScamType = scamType.trim().toLowerCase();
                const data = genderData.find(d => d['Scam Type'].trim().toLowerCase() === normalizedScamType);
                if (!data) {return;}
                const pieData = pie(Object.entries(data)
                .filter(d => d[0] !== "Scam Type")
                .map(([key, value]) => ({ key, value: +value })));
                const arcs = svgPie.selectAll("path")
                .data(pieData);

                arcs.enter()
                .append("path")
                .merge(arcs)
                .attr("d", arc)
                .attr("fill", d => color(d.data.key));

                arcs.exit().remove();
            }

            updatePieChart(d3.select("#scamTypeSelect").property("value"));

            d3.select("#scamTypeSelect").on("change", function() {
                const selectedScamType = d3.select(this).property("value");
                updatePieChart(selectedScamType);

            })
        })


 

    </script>

    


    </body>
</html>